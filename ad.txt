		{% extends "base.html" %}
		{% block extrahead %}
	 <link rel="stylesheet" type="text/css" href="/static/css/findparking.css" >
	 <script src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerwithlabel/src/markerwithlabel.js" type="text/javascript"></script>
   	 <script src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js" type="text/javascript"></script>
   	    {% endblock %}
	{% block content %}​
				<div id="searchPlaceAndFilters">
					<div id="searchPlace">
						<form action="" method="post" id="location">
					<div id="destination">Дестинация:</div>
					{% csrf_token %}
					{{ form.address }}
					<div id="fromTo">
						<div><span id="from">От:</span><span id="to">До:</span></div>
									  {{ form.fromHour }}	  		
									  {{ form.fromPeriod }}		
									  {{ form.fromDate }}			
							
									  {{ form.toHour }}	  		
									  {{ form.toPeriod }}		  		
									  {{ form.toDate }}  	
									  {{ form.lat.as_hidden }}
									{{ form.lng.as_hidden }}	
					</div>						
					<input type="button" onclick="getCoords()" id="findButton" value="Намери" />			
						<div id="button"><input hidden="hidden" type="submit" id="submitButton"/></div>	
					</form>	
					</div>
					<div id="servicePanel">
						<div id="services">Услуги</div>
						<div id="checkServices">
							<div id="firstLayer"><span class="unticked" id="elcars" onclick="makeTick(this)"></span><span class="unticked" id="security" onclick="makeTick(this)"></span><span class="unticked" id="made" onclick="makeTick(this)"></span><span class="unticked" id="discount" onclick="makeTick(this)"></span><span class="unticked" id="suv" onclick="makeTick(this)"></span></div>
							<div id="firstLayerLines"><span>Ел.коли</span><span>Сигурност</span><span>Камериер</span><span>Намаление</span><span>СУВ</span></div>
							<div id="secondLayer"><span class="unticked" id="motor" onclick="makeTick(this)"></span><span class="unticked" id="carwash" onclick="makeTick(this)"></span><span class="unticked" id="personnel" onclick="makeTick(this)"></span><span class="unticked" id="handicap" onclick="makeTick(this)"></span><span class="unticked" id="indoor" onclick="makeTick(this)"></span></div>						
							<div id="secondLayerLines"><span>Мотор</span><span>Автомивка</span><span>Персонал</span><span>Инвалид</span><span>Закрит</span></div>
						</div>
					</div>
				</div>
				<div id="parkingList">
					<div id="priceAndDistance">
						<div id="list"></div><div id="price">Цена</div><div id="distance">Разст</div>
					</div>
					<div id="filteredParkings">
						<div class="filteredParking">
							s
						</div>					
					</div>
				</div>
   			 <div id="map" ></div>

			<footer>
			</footer>
		  <script>
		  	
    var map;
    var markers = [];
    var locationSelect;
    var geocoder = new google.maps.Geocoder();
    var ib;  
            function makeTick(self)
			{
				if (self.className=="ticked") self.className="unticked";
				else self.className="ticked";
			}
    
    	function parseParkings(arr)
		{
				{% for parking in parkings %}
					var loadParking = new Object();
					loadParking.name = "{{parking.name}}";
					loadParking.address = "{{parking.address}}";
					loadParking.lat = "{{parking.lat}}";
					loadParking.lng = "{{parking.lng}}";
					loadParking.distance = "{{parking.distance}}";
					arr.push(loadParking);
				{% endfor %}
		}

    function load() {
    	var input = (document.getElementById('id_address'));
		var searchBox = new google.maps.places.SearchBox((input));
	    map = new google.maps.Map(document.getElementById("map"), {
        center: new google.maps.LatLng(42.7000, 23.3333),
        zoom: 4,
        mapTypeId: 'roadmap',
        mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU}
      });
    //  infoWindow = new google.maps.InfoWindow();
    	ib = new InfoBox();
        colorNavElement();
       if (document.getElementById('id_address').value=="") setDate();
       readOnly();
      searchLocations();
}
function getCoords()
{
	address = document.getElementById("id_address").value;
	geocoder.geocode({address: address}, function(results, status) {
       if (status == google.maps.GeocoderStatus.OK) {
   		document.getElementById('id_lat').value=results[0].geometry.location.lat();
		document.getElementById('id_lng').value=results[0].geometry.location.lng();
		document.getElementById('submitButton').click();
       } 
     });	
}
function searchLocations()
{
  		address = document.getElementById("id_address").value;
     geocoder.geocode({address: address}, function(results, status) {
       if (status == google.maps.GeocoderStatus.OK) {
         searchLocationsNear();    
       } else {
       	map.setZoom(12);
        // alert(address + ' not found');
       }
     });

		 }
	
   function clearLocations() {
     ib.close();
     for (var i = 0; i < markers.length; i++) {
       markers[i].setMap(null);
     }
     markers.length = 0;
   }

   function searchLocationsNear() {
     clearLocations(); 
     var parkings = new Array();
     parseParkings(parkings);
       var bounds = new google.maps.LatLngBounds();
       for (var i = 0; i < parkings.length; i++) {
         var name = parkings[i].name;
         var address = parkings[i].address;
         var distance = parseFloat(parkings[i].distance);
         var latlng = new google.maps.LatLng(
              parseFloat(parkings[i].lat),
              parseFloat(parkings[i].lng));
         createMarker(latlng, name, address, distance);
         bounds.extend(latlng);
       }
 		lat="{{lat}}";
 		lng="{{lng}}";
 		if(parkings.length!=0)
 		{
 		  map.fitBounds(bounds);	
 		}
 		else
 		{	
 			map.setCenter(new google.maps.LatLng(lat, lng));

 		}
 		 var marker = new google.maps.Marker({
          map: map,
          position: new google.maps.LatLng(lat, lng)
      });
       	      map.setZoom(12);
       	     
    }

    function createMarker(latlng, name, address, distance) {
      var html = "<b>" + name + "</b> <br/>" + address;
       var marker = new MarkerWithLabel({
		   position: latlng,
		   draggable: false,
		   map: map,
		   icon:"/static/imgs/parkingPointer.png",
		   labelContent: "<p>$125K</p>",
		   labelAnchor: new google.maps.Point(22, 48),
		   labelClass: "labels", // the CSS class for the label
		 });
      google.maps.event.addListener(marker, 'click', function() {
      	map.setCenter(new google.maps.LatLng(latlng.lat()+0.0007,latlng.lng()));
        var boxText = document.createElement("div");
        boxText.style.cssText = "background: url('/static/imgs/infoSheet.png') no-repeat;width:271px;height:217px;position:relative;top:-249px;left:80px;";
        boxText.innerHTML = html;
        var myOptions = {
        		content:boxText,
                disableAutoPan: false
                ,maxWidth: 0
                ,pixelOffset: new google.maps.Size(-140, 0)
                ,zIndex: null
                ,boxStyle: { 
                  height:"0px",
                  width: "0px",
                 }
                ,closeBoxMargin: "-244px -345px 2px 2px"
                ,closeBoxURL: "/static/imgs/close.png"
                ,infoBoxClearance: new google.maps.Size(1, 1)
                ,isHidden: false
                ,pane: "floatPane"
                ,enableEventPropagation: false
        };
        ib.setOptions(myOptions);
        ib.open(map, marker);
              
      });      
    	  markers.push(marker);   
    }

		window.onload=load();
		</script>
	{% endblock %}
